<!DOCTYPE html>
<html>
<head>
    <title>üíä Pharmacy Agent</title>
    <style>
        button { padding: 12px 24px; margin: 5px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
        #voiceBtn { background: #4CAF50; color: white; }
        #stopBtn { background: #f44336; color: white; display: none; }
        #submitBtn { background: #2196F3; color: white; display: none; }
        #status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status-connected { background: #d4edda; color: #155724; }
        #output { margin-top: 20px; padding: 20px; background: #f8f9fa; max-height: 500px; overflow-y: auto; border-radius: 5px; }
        pre { background: white; padding: 15px; border-radius: 3px; overflow-x: auto; }
        #transcript { font-size: 18px; color: #2196F3; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üíä Pharmacy Voice & OCR Agent (Web Speech API)</h1>
    <div id="status" class="status-connected">‚úÖ Ready (Chrome/Edge recommended)</div>
    
    <!-- Voice Section -->
    <div>
        <button id="voiceBtn">üé§ Start Speaking</button>
        <button id="stopBtn">‚èπÔ∏è Stop & Process</button>
        <div id="transcript">Click start to speak your prescription...</div>
    </div>
    
    <!-- Image Section -->
    <div style="margin-top: 20px;">
        <input type="file" id="imageInput" accept="image/*">
        <button id="submitBtn">üì§ Submit Image</button>
    </div>
    
    <div id="output"></div>

    <script>
    class PharmacyAgent {
        constructor() {
            this.recognition = null;
            this.elements = {
                status: document.getElementById('status'),
                voiceBtn: document.getElementById('voiceBtn'),
                stopBtn: document.getElementById('stopBtn'),
                transcript: document.getElementById('transcript'),
                imageInput: document.getElementById('imageInput'),
                submitBtn: document.getElementById('submitBtn'),
                output: document.getElementById('output')
            };
            this.init();
        }
        
        init() {
            // Initialize Web Speech API
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.lang = 'en-US';
                
                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    this.elements.transcript.textContent = transcript;
                    this.processSpeech(transcript);
                };
                
                this.recognition.onerror = (event) => {
                    this.addOutput(`‚ùå Speech error: ${event.error}`, 'error');
                };
            } else {
                this.addOutput('‚ùå Web Speech API not supported. Use Chrome/Edge.', 'error');
            }
            
            this.bindEvents();
        }
        
        bindEvents() {
            this.elements.voiceBtn.onclick = () => this.startSpeech();
            this.elements.stopBtn.onclick = () => this.stopSpeech();
            this.elements.imageInput.onchange = (e) => {
                this.elements.submitBtn.style.display = e.target.files[0] ? 'inline-block' : 'none';
            };
            this.elements.submitBtn.onclick = () => this.submitImage();
        }
        
        startSpeech() {
            if (this.recognition) {
                this.recognition.start();
                this.elements.voiceBtn.style.display = 'none';
                this.elements.stopBtn.style.display = 'inline-block';
                this.elements.transcript.textContent = 'Listening... Speak now!';
            }
        }
        
        stopSpeech() {
            if (this.recognition) {
                this.recognition.stop();
                this.elements.voiceBtn.style.display = 'inline-block';
                this.elements.stopBtn.style.display = 'none';
            }
        }
        
        async processSpeech(transcript) {
            try {
                const response = await fetch('/process_speech/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({transcript: transcript})
                });
                const data = await response.json();
                this.addOutputData(data);
            } catch (err) {
                this.addOutput(`‚ùå Error: ${err.message}`, 'error');
            }
        }
        
        async submitImage() {
            const file = this.elements.imageInput.files[0];
            if (!file) return;
            
            const form = new FormData();
            form.append('file', file);
            
            try {
                this.addOutput('üì§ Processing image...');
                const res = await fetch('/ocr_prescription/', { method: 'POST', body: form });
                const data = await res.json();
                this.addOutputData(data);
            } catch (err) {
                this.addOutput(`‚ùå Image error: ${err.message}`, 'error');
            }
        }
        
        addOutputData(data) {
            const type = data.status === 'success' ? 'success' : 'info';
            let html = `<div class="result-${type}">`;
            
            if (data.transcribed_text) {
                html += `<h3>üé§ ${data.transcribed_text}</h3>`;
            }
            if (data.raw_ocr) {
                html += `<h4>üìÑ ${data.raw_ocr}</h4>`;
            }
            
            html += `<pre>${JSON.stringify(data.prescription_details || data.structured_prescription, null, 2)}</pre>`;
            html += '</div>';
            
            this.elements.output.innerHTML += html;
            this.elements.output.scrollTop = this.elements.output.scrollHeight;
        }
        
        addOutput(message, type = 'info') {
            const className = type === 'error' ? 'error' : 'info';
            this.elements.output.innerHTML += `<p class="${className}">${message}</p>`;
            this.elements.output.scrollTop = this.elements.output.scrollHeight;
        }
    }
    
    const app = new PharmacyAgent();
    </script>
</body>
</html>
